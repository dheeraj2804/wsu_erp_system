{% extends "base.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
  <div>
    <h1 class="h3 mb-0">Loans</h1>
    <p class="text-muted mb-0">
      Overview of equipment loans, return status, and overdue fees.
    </p>
  </div>
</div>

<div class="card shadow-sm">
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-hover mb-0 align-middle">
        <thead class="table-light">
          <tr>
            <th scope="col">ID</th>
            <th scope="col">Reservation</th>
            <th scope="col">User</th>
            <th scope="col">Checked Out</th>
            <th scope="col">Due</th>
            <th scope="col">Returned</th>
            <th scope="col" class="text-end">Overdue Fee</th>
            <th scope="col" class="text-center">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% if loans %}
            {% for loan in loans %}
              <tr>
                <td>{{ loan.loan_id }}</td>
                <td>#{{ loan.reservation_id }}</td>
                <td>{{ loan.reservation.user.full_name }}</td>
                <td>
                  {% if loan.checked_out_at %}
                    {{ loan.checked_out_at.strftime("%Y-%m-%d %H:%M") }}
                  {% else %}
                    -
                  {% endif %}
                </td>
                <td>
                  {% if loan.due_at %}
                    {{ loan.due_at.strftime("%Y-%m-%d %H:%M") }}
                  {% else %}
                    -
                  {% endif %}
                </td>
                <td>
                  {% if loan.returned_at %}
                    {{ loan.returned_at.strftime("%Y-%m-%d %H:%M") }}
                  {% else %}
                    <span class="badge bg-warning text-dark">Not returned</span>
                  {% endif %}
                </td>
                <td class="text-end">
                  {% if loan.overdue_fee and loan.overdue_fee > 0 %}
                    <span class="fw-semibold text-danger">
                      ${{ "%.2f"|format(loan.overdue_fee) }}
                    </span>
                  {% else %}
                    <span class="text-muted">$0.00</span>
                  {% endif %}
                </td>
                <td class="text-center">
                  {% if loan.returned_at %}
                    <span class="badge bg-success">Closed</span>
                  {% else %}
                    <form
                      method="POST"
                      action="{{ url_for('loans_return', loan_id=loan.loan_id) }}"
                      class="d-inline"
                    >
                      <button type="submit" class="btn btn-sm btn-outline-primary">
                        Mark Returned
                      </button>
                    </form>
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
          {% else %}
            <tr>
              <td colspan="8" class="text-center py-4 text-muted">
                No loans have been created yet.
              </td>
            </tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </div>
</div>
{% endblock %}
