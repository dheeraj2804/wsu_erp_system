<!-- templates/tickets_list.html -->
{% extends "base.html" %}
{% block content %}

{# -----------------------
   Counts for header cards
   ----------------------- #}
{% set total_count = tickets|length %}
{% set open_count = tickets|selectattr('status', 'equalto', 'Open')|list|length %}
{% set in_progress_count = tickets|selectattr('status', 'equalto', 'In Progress')|list|length %}
{% set closed_count = tickets|selectattr('status', 'equalto', 'Closed')|list|length %}

<!-- Page Header -->
<div class="d-flex justify-content-between align-items-start mb-4">
  <div>
    <h1 class="h3 fw-bold mb-1">
      {% if is_staff %}All Service Tickets{% else %}My Service Tickets{% endif %}
    </h1>
    <p class="text-muted mb-0">
      {% if is_staff %}
        Review issues, assign technicians, and track maintenance progress.
      {% else %}
        Report equipment issues and follow updates from Tech Staff.
      {% endif %}
    </p>
  </div>

  <a href="{{ url_for('tickets_create') }}" class="btn btn-primary px-4">
    + New Ticket
  </a>
</div>

<!-- Stats Row -->
<div class="row g-3 mb-4">
  <div class="col-md-3">
    <div class="card shadow-sm border-0 h-100">
      <div class="card-body">
        <div class="text-muted small text-uppercase">Total</div>
        <div class="h4 fw-bold mb-0">{{ total_count }}</div>
      </div>
    </div>
  </div>

  <div class="col-md-3">
    <div class="card shadow-sm border-0 h-100">
      <div class="card-body">
        <div class="text-muted small text-uppercase">Open</div>
        <div class="h4 fw-bold text-warning mb-0">{{ open_count }}</div>
      </div>
    </div>
  </div>

  <div class="col-md-3">
    <div class="card shadow-sm border-0 h-100">
      <div class="card-body">
        <div class="text-muted small text-uppercase">In Progress</div>
        <div class="h4 fw-bold text-info mb-0">{{ in_progress_count }}</div>
      </div>
    </div>
  </div>

  <div class="col-md-3">
    <div class="card shadow-sm border-0 h-100">
      <div class="card-body">
        <div class="text-muted small text-uppercase">Closed</div>
        <div class="h4 fw-bold text-success mb-0">{{ closed_count }}</div>
      </div>
    </div>
  </div>
</div>

{% if is_staff and total_count > 0 %}
<!-- Staff-only Chart -->
<div class="card shadow-sm border-0 mb-4">
  <div class="card-body">
    <h6 class="text-muted text-uppercase small mb-1">Overview</h6>
    <h5 class="mb-3">Tickets by Status</h5>
    <div style="height: 260px">
      <canvas id="ticketsStatusChart"></canvas>
    </div>
  </div>
</div>
{% endif %}

<!-- Filters + Search -->
<div class="card shadow-sm border-0 mb-3">
  <div class="card-body d-flex flex-wrap gap-2 align-items-center">
    <div class="fw-semibold text-muted small text-uppercase me-2">Filters</div>

    <div class="flex-grow-1" style="min-width: 220px">
      <input
        id="ticketSearch"
        type="text"
        class="form-control form-control-sm"
        placeholder="Search by equipment name or ticket ID..."
      />
    </div>

    <div style="min-width: 160px">
      <select id="statusFilter" class="form-select form-select-sm">
        <option value="">Status: All</option>
        <option value="Open">Open</option>
        <option value="In Progress">In Progress</option>
        <option value="Closed">Closed</option>
      </select>
    </div>

    <div style="min-width: 160px">
      <select id="severityFilter" class="form-select form-select-sm">
        <option value="">Severity: All</option>
        <option value="Low">Low</option>
        <option value="Medium">Medium</option>
        <option value="High">High</option>
        <option value="Critical">Critical</option>
      </select>
    </div>
  </div>
</div>

<!-- Tickets Table -->
<div class="card shadow-sm border-0">
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-hover align-middle mb-0">
        <thead class="table-light">
          <tr>
            <th>ID</th>
            <th>Equipment</th>
            <th>Severity</th>
            <th>Status</th>
            {% if is_staff %}
              <th>Opened By</th>
              <th>Assigned To</th>
            {% endif %}
            <th>Opened</th>
            <th style="width: 140px" class="text-center">Action</th>
          </tr>
        </thead>

        <tbody id="ticketsTableBody">
        {% if tickets %}
          {% for t in tickets %}
          <tr
            data-id="{{ t.ticket_id }}"
            data-equipment="{{ t.equipment.name | lower }}"
            data-status="{{ t.status }}"
            data-severity="{{ t.severity }}"
          >
            <td class="fw-semibold">#{{ t.ticket_id }}</td>
            <td>{{ t.equipment.name }}</td>

            <td>
              <span class="badge
                {% if t.severity == 'Critical' %}bg-danger
                {% elif t.severity == 'High' %}bg-danger-subtle text-danger
                {% elif t.severity == 'Medium' %}bg-warning text-dark
                {% elif t.severity == 'Low' %}bg-secondary
                {% else %}bg-light text-muted{% endif %}
              ">
                {{ t.severity }}
              </span>
            </td>

            <td>
              <span class="badge
                {% if t.status == 'Open' %}bg-warning text-dark
                {% elif t.status == 'In Progress' %}bg-info text-dark
                {% elif t.status == 'Closed' %}bg-success
                {% else %}bg-secondary{% endif %}
              ">
                {{ t.status }}
              </span>
            </td>

            {% if is_staff %}
            <td>{{ t.opened_by_user.full_name }}</td>
            <td>
              {% if t.assigned_to_user %}
                {{ t.assigned_to_user.full_name }}
              {% else %}
                <span class="text-muted">Unassigned</span>
              {% endif %}
            </td>
            {% endif %}

            <td>{{ t.opened_at.strftime("%Y-%m-%d %H:%M") }}</td>

            <td class="text-center">
              <a href="{{ url_for('ticket_detail', ticket_id=t.ticket_id) }}"
                 class="btn btn-sm btn-outline-primary">
                 {% if is_staff %}View / Manage{% else %}View{% endif %}
              </a>
            </td>
          </tr>
          {% endfor %}
        {% else %}
          <tr>
            <td colspan="{% if is_staff %}8{% else %}6{% endif %}" class="text-center py-5 text-muted">
              {% if is_staff %}
                No tickets found yet. Students will appear here once they report issues.
              {% else %}
                You donâ€™t have any tickets yet. Click <strong>New Ticket</strong> to report an issue.
              {% endif %}
            </td>
          </tr>
        {% endif %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Search + filter JS -->
<script>
(function () {
  const searchInput = document.getElementById("ticketSearch");
  const statusFilter = document.getElementById("statusFilter");
  const severityFilter = document.getElementById("severityFilter");
  const rows = Array.from(document.querySelectorAll("#ticketsTableBody tr"));

  function applyFilters() {
    const q = (searchInput.value || "").toLowerCase().trim();
    const statusVal = statusFilter.value;
    const severityVal = severityFilter.value;

    rows.forEach((row) => {
      const equipment = (row.getAttribute("data-equipment") || "");
      const id = (row.getAttribute("data-id") || "");
      const status = row.getAttribute("data-status") || "";
      const severity = row.getAttribute("data-severity") || "";

      let visible = true;
      if (q && !(equipment.includes(q) || id.includes(q))) visible = false;
      if (statusVal && status !== statusVal) visible = false;
      if (severityVal && severity !== severityVal) visible = false;

      row.style.display = visible ? "" : "none";
    });
  }

  if (searchInput) searchInput.addEventListener("input", applyFilters);
  if (statusFilter) statusFilter.addEventListener("change", applyFilters);
  if (severityFilter) severityFilter.addEventListener("change", applyFilters);
})();
</script>

{% if is_staff and total_count > 0 %}
<script>
(function () {
  const canvas = document.getElementById("ticketsStatusChart");
  if (!canvas || !window.Chart) return;

  const ctx = canvas.getContext("2d");
  new Chart(ctx, {
    type: "bar",
    data: {
      labels: ["Open", "In Progress", "Closed"],
      datasets: [{
        label: "Tickets",
        data: [{{ open_count }}, {{ in_progress_count }}, {{ closed_count }}],
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: { y: { beginAtZero: true, ticks: { precision: 0 } } },
      plugins: { legend: { display: false } }
    }
  });
})();
</script>
{% endif %}

{% endblock %}
