{% extends "base.html" %}
{% block content %}

<div class="d-flex justify-content-between align-items-center mb-3">
  <div>
    <h2 class="mb-1">Reservation #{{ reservation.reservation_id }}</h2>
    <small class="text-muted">
      {% if is_staff %}
        Detailed view of a student's reservation, including items and status actions.
      {% else %}
        Full details of your reservation and the equipment you requested.
      {% endif %}
    </small>
  </div>

  <a href="{{ url_for('reservations_list') }}" class="btn btn-outline-secondary btn-sm">
    &laquo; Back to Reservations
  </a>
</div>

<div class="row g-3">
  <!-- Left column -->
  <div class="col-md-6">

    <!-- Summary card -->
    <div class="card shadow-sm mb-3">
      <div class="card-body">
        <h5 class="card-title mb-3">Reservation Overview</h5>
        <dl class="row mb-0">
          <dt class="col-sm-4">Student</dt>
          <dd class="col-sm-8">{{ reservation.user.full_name }}</dd>

          <dt class="col-sm-4">Email</dt>
          <dd class="col-sm-8">{{ reservation.user.email }}</dd>

          <dt class="col-sm-4">Start</dt>
          <dd class="col-sm-8">
            {{ reservation.start_date.strftime("%Y-%m-%d %H:%M") }}
          </dd>

          <dt class="col-sm-4">End</dt>
          <dd class="col-sm-8">
            {{ reservation.end_date.strftime("%Y-%m-%d %H:%M") }}
          </dd>

          <dt class="col-sm-4">Status</dt>
          <dd class="col-sm-8">
            <span class="badge
              {% if reservation.status == 'Approved' %}bg-success
              {% elif reservation.status == 'Pending' %}bg-warning text-dark
              {% elif reservation.status == 'Denied' %}bg-danger
              {% else %}bg-secondary{% endif %}
            ">
              {{ reservation.status }}
            </span>
          </dd>
        </dl>
      </div>
    </div>

    {% if is_staff %}
    <!-- Staff Action Panel -->
    <div class="card shadow-sm">
      <div class="card-body">
        <h6 class="card-title mb-2">Review & Actions</h6>
        <p class="text-muted small mb-3">
          Update the reservation status or convert an approved reservation into a loan.
        </p>

        <div class="d-flex flex-wrap gap-2 mb-3">

          <!-- Approve -->
          <form method="post"
                action="{{ url_for('reservation_set_status', reservation_id=reservation.reservation_id) }}"
                class="d-inline">
            <input type="hidden" name="status" value="Approved" />
            <button class="btn btn-success btn-sm"
                    {% if reservation.status == 'Approved' %}disabled{% endif %}>
              Approve
            </button>
          </form>

          <!-- Deny -->
          <form method="post"
                action="{{ url_for('reservation_set_status', reservation_id=reservation.reservation_id) }}"
                class="d-inline">
            <input type="hidden" name="status" value="Denied" />
            <button class="btn btn-outline-danger btn-sm"
                    {% if reservation.status == 'Denied' %}disabled{% endif %}>
              Deny
            </button>
          </form>

          <!-- Loan generation -->
          {% if reservation.status == 'Approved' and not reservation.loan %}
            <a href="{{ url_for('loans_create', reservation_id=reservation.reservation_id) }}"
               class="btn btn-primary btn-sm">
              Create Loan
            </a>
          {% elif reservation.loan %}
            <span class="badge bg-info text-dark align-self-center">
              Loan #{{ reservation.loan.loan_id }} created
            </span>
          {% endif %}
        </div>

        <div class="border-top pt-2">
          <small class="text-muted">
            Typical workflow:
            <span class="badge bg-light text-muted border mx-1">Pending</span>
            →
            <span class="badge bg-light text-muted border mx-1">Approved / Denied</span>

            {% if reservation.loan %}
              → <span class="badge bg-light text-muted border mx-1">Loan #{{ reservation.loan.loan_id }}</span>
            {% else %}
              → <span class="badge bg-light text-muted border mx-1">Loan</span>
            {% endif %}
          </small>
        </div>
      </div>
    </div>

    {% else %}
    <!-- Student Info -->
    <div class="card shadow-sm">
      <div class="card-body">
        <h6 class="card-title mb-2">What happens next?</h6>
        <p class="text-muted small mb-0">
          Once staff review your request, the status will update. If approved, a loan will be created when you pick up the equipment.
        </p>
      </div>
    </div>
    {% endif %}
  </div>

  <!-- Right column -->
  <div class="col-md-6">
    <div class="card shadow-sm h-100">
      <div class="card-body d-flex flex-column">
        <h5 class="card-title mb-3">Requested Equipment</h5>

        {% if reservation.items %}
          <ul class="list-group mb-3">
            {% for item in reservation.items %}
            <li class="list-group-item d-flex justify-content-between">
              <div>
                <div class="fw-semibold">
                  {{ item.equipment.name }}
                  <span class="badge bg-secondary ms-2">
                    #{{ item.equipment.equipment_id }}
                  </span>
                </div>
                <div class="small text-muted">
                  {{ item.equipment.category }} · {{ item.equipment.location }}
                </div>
              </div>
            </li>
            {% endfor %}
          </ul>
        {% else %}
          <p class="text-muted">No equipment attached to this reservation.</p>
        {% endif %}

        <div class="mt-auto pt-2 border-top">
          <small class="text-muted">
            Need changes?  
            {% if is_staff %}
              Ask the student to submit a corrected reservation.
            {% else %}
              Submit a new reservation with the updated details.
            {% endif %}
          </small>
        </div>
      </div>
    </div>
  </div>
</div>

{% endblock %}
